<% if turbo_frame_modal? %>
  <%= turbo_frame_tag "modal" do %>
    <%= render layout: "shared/modal_form", locals: { title: @transaction.description } do %>
      <div class="space-y-4">
        <div class="flex items-center gap-2">
          <%= render BadgeComponent.new(variant: @transaction.income? ? :success : (@transaction.transfer? ? :info : :danger)) do %>
            <%= @transaction.transaction_type.humanize %>
          <% end %>
          <span class="text-sm text-text-secondary"><%= @transaction.date.strftime("%B %d, %Y") %></span>
          <% if @transaction.flag.present? %>
            <span class="inline-flex items-center justify-center w-5 h-5 rounded-md <%= @transaction.flag_color[:bg] %>">
              <%= heroicon "flag", variant: :mini, options: { class: "w-3 h-3 #{@transaction.flag_color[:text]}" } %>
            </span>
          <% end %>
          <% if @transaction.needs_review? %>
            <%= render BadgeComponent.new(variant: :warning, size: :sm) do %>
              Needs Review
            <% end %>
          <% end %>
        </div>

        <div class="glass rounded-xl p-4">
          <p class="text-sm text-text-secondary">Amount</p>
          <p class="text-3xl font-bold <%= amount_color_class(@transaction) %>">
            <%= formatted_amount(@transaction) %>
          </p>
          <% if @transaction.converted? %>
            <p class="text-sm text-text-muted mt-1">
              Original: <%= number_to_currency(@transaction.original_amount) %> <%= @transaction.currency %>
              <span class="text-text-muted/60">@ <%= @transaction.exchange_rate %></span>
            </p>
          <% end %>
        </div>

        <div class="space-y-2.5">
          <% if @transaction.payee.present? %>
            <div class="flex justify-between items-center">
              <span class="text-sm text-text-secondary">Payee</span>
              <span class="text-sm font-medium text-text-primary"><%= @transaction.payee %></span>
            </div>
          <% end %>
          <div class="flex justify-between items-center">
            <span class="text-sm text-text-secondary">Account</span>
            <span class="text-sm font-medium text-text-primary"><%= @transaction.account.name %></span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm text-text-secondary">Category</span>
            <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md text-xs font-medium glass border border-glass-border text-text-secondary">
              <span class="w-1.5 h-1.5 rounded-full" style="background-color: <%= @transaction.category.color %>"></span>
              <%= @transaction.category.name %>
            </span>
          </div>
          <% if @transaction.contra_category.present? %>
            <div class="flex justify-between items-center">
              <span class="text-sm text-text-secondary">Contra Category</span>
              <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md text-xs font-medium glass border border-glass-border text-text-secondary">
                <span class="w-1.5 h-1.5 rounded-full" style="background-color: <%= @transaction.contra_category.color %>"></span>
                <%= @transaction.contra_category.name %>
              </span>
            </div>
          <% end %>
          <% if @transaction.tags.any? %>
            <div class="flex justify-between items-center">
              <span class="text-sm text-text-secondary">Tags</span>
              <div class="flex gap-1">
                <% @transaction.tags.each do |tag| %>
                  <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium border" style="background-color: <%= tag.color %>15; border-color: <%= tag.color %>30; color: <%= tag.color %>">
                    <%= tag.name %>
                  </span>
                <% end %>
              </div>
            </div>
          <% end %>
          <% if @transaction.custom_fields.present? && @transaction.custom_fields.any? { |_k, v| v.present? } %>
            <div class="pt-2 border-t border-glass-border">
              <p class="text-sm text-text-secondary mb-2">Custom Fields</p>
              <div class="space-y-1">
                <% @transaction.custom_fields.each do |field_id, value| %>
                  <% next if value.blank? %>
                  <% field_def = current_user.custom_field_definitions.find_by(id: field_id) %>
                  <% next unless field_def %>
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-text-secondary"><%= field_def.name %></span>
                    <span class="text-sm font-medium text-text-primary">
                      <%= value == "true" ? "Yes" : (value == "false" ? "No" : value) %>
                    </span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
          <% if @transaction.split? %>
            <div class="pt-2 border-t border-glass-border">
              <p class="text-sm text-text-secondary mb-2">Split Categories</p>
              <div class="space-y-1">
                <% @transaction.transaction_splits.each do |split| %>
                  <div class="flex justify-between items-center">
                    <span class="text-sm text-text-primary"><%= split.category.name %></span>
                    <span class="text-sm font-medium text-text-primary"><%= number_to_currency(split.amount) %></span>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
          <% if @transaction.notes.present? %>
            <div class="pt-2 border-t border-glass-border">
              <p class="text-sm text-text-secondary mb-1">Notes</p>
              <p class="text-sm text-text-primary"><%= @transaction.notes %></p>
            </div>
          <% end %>
          <% if @transaction.transaction_group.present? %>
            <div class="pt-2 border-t border-glass-border">
              <p class="text-sm text-text-secondary mb-1">Transaction Group</p>
              <div class="flex items-center gap-2">
                <% display = @transaction.transaction_group.type_display %>
                <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md text-xs font-medium <%= display[:bg] %> <%= display[:text] %>">
                  <%= heroicon display[:icon], variant: :mini, options: { class: "w-3.5 h-3.5" } %>
                  <%= @transaction.transaction_group.group_type.humanize %>
                </span>
                <%= link_to @transaction.transaction_group.name, transaction_group_path(@transaction.transaction_group), class: "text-sm font-medium text-primary-600 dark:text-primary-400 hover:underline" %>
              </div>
            </div>
          <% end %>
          <% if @transaction.receipts.attached? %>
            <div class="pt-2 border-t border-glass-border">
              <p class="text-sm text-text-secondary mb-2">Receipts</p>
              <div class="flex flex-wrap gap-2">
                <% @transaction.receipts.each do |receipt| %>
                  <% if receipt.content_type.start_with?("image/") %>
                    <%= link_to url_for(receipt), target: "_blank", class: "block w-16 h-16 rounded-lg overflow-hidden border border-glass-border hover:border-primary-500 transition-colors" do %>
                      <%= image_tag url_for(receipt), class: "w-full h-full object-cover" %>
                    <% end %>
                  <% else %>
                    <%= link_to url_for(receipt), target: "_blank", class: "flex flex-col items-center justify-center w-16 h-16 rounded-lg border border-glass-border hover:border-primary-500 transition-colors glass" do %>
                      <%= heroicon "document", variant: :outline, options: { class: "w-6 h-6 text-danger-500" } %>
                      <span class="text-[8px] text-text-muted mt-0.5">PDF</span>
                    <% end %>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

        <div class="flex items-center gap-2 pt-2 border-t border-glass-border">
          <%= render ButtonComponent.new(variant: :secondary, size: :sm, href: edit_transaction_path(@transaction), icon: "pencil", data: { turbo_frame: "modal" }) do %>
            Edit
          <% end %>
          <%= render ButtonComponent.new(variant: :danger, size: :sm, href: transaction_path(@transaction), method: :delete, confirm: "Are you sure?", icon: "trash") do %>
            Delete
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
<% else %>
  <div class="max-w-2xl space-y-6">
    <%= render PageHeaderComponent.new(title: @transaction.description) do |header| %>
      <% header.with_actions do %>
        <%= render ButtonComponent.new(variant: :secondary, href: edit_transaction_path(@transaction), icon: "pencil", data: { turbo_frame: "modal" }) do %>
          Edit
        <% end %>
        <%= render ButtonComponent.new(variant: :danger, href: transaction_path(@transaction), method: :delete, confirm: "Are you sure?", icon: "trash") do %>
          Delete
        <% end %>
      <% end %>
    <% end %>

    <%= render CardComponent.new do %>
      <div class="space-y-4">
        <div class="flex justify-between">
          <span class="text-text-secondary">Amount</span>
          <div class="text-right">
            <span class="text-xl font-bold <%= amount_color_class(@transaction) %>">
              <%= formatted_amount(@transaction) %>
            </span>
            <% if @transaction.converted? %>
              <p class="text-sm text-text-muted">
                Original: <%= number_to_currency(@transaction.original_amount) %> <%= @transaction.currency %>
                <span class="text-text-muted/60">@ <%= @transaction.exchange_rate %></span>
              </p>
            <% end %>
          </div>
        </div>
        <div class="flex justify-between">
          <span class="text-text-secondary">Type</span>
          <%= render BadgeComponent.new(variant: @transaction.income? ? :success : :danger) do %>
            <%= @transaction.transaction_type.humanize %>
          <% end %>
        </div>
        <div class="flex justify-between">
          <span class="text-text-secondary">Date</span>
          <span class="text-text-primary"><%= @transaction.date.strftime("%B %d, %Y") %></span>
        </div>
        <% if @transaction.payee.present? %>
          <div class="flex justify-between">
            <span class="text-text-secondary">Payee</span>
            <span class="text-text-primary"><%= @transaction.payee %></span>
          </div>
        <% end %>
        <div class="flex justify-between">
          <span class="text-text-secondary">Account</span>
          <%= link_to @transaction.account.name, account_path(@transaction.account), class: "text-primary-600 hover:text-primary-700" %>
        </div>
        <div class="flex justify-between">
          <span class="text-text-secondary">Category</span>
          <span class="text-text-primary"><%= @transaction.category.name %></span>
        </div>
        <% if @transaction.contra_category.present? %>
          <div class="flex justify-between">
            <span class="text-text-secondary">Contra Category</span>
            <span class="text-text-primary"><%= @transaction.contra_category.name %></span>
          </div>
        <% end %>
        <% if current_user.preference.accounting_mode? %>
          <div class="flex justify-between">
            <span class="text-text-secondary">Debit</span>
            <span class="text-text-primary">
              <%= @transaction.expense? || @transaction.transfer? ? number_to_currency(@transaction.amount) : "-" %>
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-text-secondary">Credit</span>
            <span class="text-text-primary">
              <%= @transaction.income? ? number_to_currency(@transaction.amount) : "-" %>
            </span>
          </div>
        <% end %>
        <% if @transaction.custom_fields.present? && @transaction.custom_fields.any? { |_k, v| v.present? } %>
          <div class="pt-4 border-t border-border">
            <p class="text-sm text-text-secondary mb-2">Custom Fields</p>
            <div class="space-y-2">
              <% @transaction.custom_fields.each do |field_id, value| %>
                <% next if value.blank? %>
                <% field_def = current_user.custom_field_definitions.find_by(id: field_id) %>
                <% next unless field_def %>
                <div class="flex justify-between">
                  <span class="text-text-secondary"><%= field_def.name %></span>
                  <span class="text-text-primary">
                    <%= value == "true" ? "Yes" : (value == "false" ? "No" : value) %>
                  </span>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
        <% if @transaction.flag.present? %>
          <div class="flex justify-between">
            <span class="text-text-secondary">Flag</span>
            <span class="inline-flex items-center gap-1.5 <%= @transaction.flag_color[:text] %>">
              <%= heroicon "flag", variant: :mini, options: { class: "w-4 h-4" } %>
              <%= @transaction.flag.humanize %>
            </span>
          </div>
        <% end %>
        <div class="flex justify-between">
          <span class="text-text-secondary">Status</span>
          <span class="text-text-primary"><%= @transaction.clearing_status.humanize %></span>
        </div>
        <% if @transaction.notes.present? %>
          <div class="pt-4 border-t border-border">
            <p class="text-sm text-text-secondary mb-1">Notes</p>
            <p class="text-text-primary"><%= @transaction.notes %></p>
          </div>
        <% end %>
        <% if @transaction.transaction_group.present? %>
          <div class="pt-4 border-t border-border">
            <p class="text-sm text-text-secondary mb-2">Transaction Group</p>
            <div class="flex items-center gap-2">
              <% display = @transaction.transaction_group.type_display %>
              <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-medium <%= display[:bg] %> <%= display[:text] %>">
                <%= heroicon display[:icon], variant: :mini, options: { class: "w-3.5 h-3.5" } %>
                <%= @transaction.transaction_group.group_type.humanize %>
              </span>
              <%= link_to @transaction.transaction_group.name, transaction_group_path(@transaction.transaction_group), class: "text-sm font-medium text-primary-600 dark:text-primary-400 hover:underline" %>
              <span class="text-xs text-text-muted">(<%= @transaction.transaction_group.transactions.count %> transactions)</span>
            </div>
          </div>
        <% end %>
        <% if @transaction.receipts.attached? %>
          <div class="pt-4 border-t border-border">
            <p class="text-sm text-text-secondary mb-2">Receipts</p>
            <div class="flex flex-wrap gap-3">
              <% @transaction.receipts.each do |receipt| %>
                <div class="relative group">
                  <% if receipt.content_type.start_with?("image/") %>
                    <%= link_to url_for(receipt), target: "_blank", class: "block w-24 h-24 rounded-xl overflow-hidden border border-glass-border hover:border-primary-500 transition-colors shadow-sm" do %>
                      <%= image_tag url_for(receipt), class: "w-full h-full object-cover" %>
                    <% end %>
                  <% else %>
                    <%= link_to url_for(receipt), target: "_blank", class: "flex flex-col items-center justify-center w-24 h-24 rounded-xl border border-glass-border hover:border-primary-500 transition-colors glass shadow-sm" do %>
                      <%= heroicon "document", variant: :outline, options: { class: "w-8 h-8 text-danger-500" } %>
                      <span class="text-[10px] text-text-muted mt-1"><%= receipt.filename %></span>
                    <% end %>
                  <% end %>
                  <%= button_to remove_receipt_transaction_path(@transaction, receipt_id: receipt.id), method: :delete,
                    class: "absolute -top-1 -right-1 w-5 h-5 rounded-full bg-danger-500 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-sm",
                    data: { turbo_confirm: "Remove this receipt?" } do %>
                    <%= heroicon "x-mark", variant: :mini, options: { class: "w-3 h-3" } %>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

    <div>
      <%= link_to "Back to transactions", transactions_path, class: "text-sm text-text-secondary hover:text-text-primary" %>
    </div>
  </div>
<% end %>
