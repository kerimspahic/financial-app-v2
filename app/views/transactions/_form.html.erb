<%= form_with(model: transaction, multipart: true, class: "space-y-6", data: { controller: "transfer-toggle split-transaction currency-conversion" }) do |form| %>
  <% if transaction.errors.any? %>
    <%= render AlertComponent.new(variant: :danger, dismissable: false, timeout: 0) do %>
      <strong><%= pluralize(transaction.errors.count, "error") %> prevented this transaction from being saved:</strong>
      <ul class="mt-2 list-disc list-inside">
        <% transaction.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    <% end %>
  <% end %>

  <%= render InputComponent.new(form: form, field: :payee, label: "Payee / Merchant", placeholder: "e.g., Amazon, Walmart") %>

  <%= render InputComponent.new(form: form, field: :description, label: "Description", placeholder: "e.g., Grocery shopping") %>

  <div class="grid grid-cols-2 gap-4">
    <%= render InputComponent.new(form: form, field: :amount, label: "Amount", type: :number, step: "0.01", min: "0.01") %>
    <%= render InputComponent.new(
      form: form,
      field: :transaction_type,
      label: "Type",
      type: :select,
      collection: Transaction.transaction_types.keys.map { |t| [t.humanize, t] },
      include_blank: "Select type",
      data: { transfer_toggle_target: "typeSelect", action: "change->transfer-toggle#toggle" }
    ) %>
  </div>

  <%= render InputComponent.new(form: form, field: :date, label: "Date", type: :date) %>

  <%# Multi-Currency Support %>
  <div>
    <label class="block text-sm font-medium text-text-primary mb-1.5">Currency</label>
    <%= form.select :currency,
      ExchangeConversion::SUPPORTED_CURRENCIES.map { |code, name| [ "#{code} - #{name}", code ] },
      { selected: transaction.currency || "USD" },
      class: "block w-full rounded-xl border border-input-border px-4 py-2.5 text-sm glass text-text-primary focus:outline-none focus:ring-2 focus:ring-input-focus transition-all duration-200",
      data: { currency_conversion_target: "currencySelect", action: "change->currency-conversion#toggleCurrencySection" } %>
  </div>

  <div data-currency-conversion-target="currencySection" class="<%= transaction.converted? ? '' : 'hidden' %> space-y-4 p-4 rounded-xl glass border border-glass-border">
    <p class="text-xs font-medium text-text-secondary uppercase tracking-wide">Foreign Currency Conversion</p>
    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-text-primary mb-1.5">Original Amount</label>
        <%= form.number_field :original_amount, step: "0.01", min: "0.01",
          placeholder: "Amount in source currency",
          class: "block w-full rounded-xl border border-input-border px-4 py-2.5 text-sm glass text-text-primary placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-input-focus transition-all duration-200",
          data: { currency_conversion_target: "originalAmount", action: "input->currency-conversion#fetchRate" } %>
      </div>
      <div>
        <label class="block text-sm font-medium text-text-primary mb-1.5">Exchange Rate</label>
        <%= form.number_field :exchange_rate, step: "0.000001", min: "0",
          placeholder: "e.g., 1.085000",
          class: "block w-full rounded-xl border border-input-border px-4 py-2.5 text-sm glass text-text-primary placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-input-focus transition-all duration-200",
          data: { currency_conversion_target: "exchangeRate" } %>
      </div>
    </div>
    <p data-currency-conversion-target="convertedPreview" class="text-sm text-text-secondary italic"></p>
  </div>

  <div class="grid grid-cols-2 gap-4">
    <%= render InputComponent.new(
      form: form,
      field: :account_id,
      label: "From Account",
      type: :select,
      collection: current_user.accounts.active.ordered.map { |a| [a.name, a.id] },
      include_blank: "Select account"
    ) %>
    <%= render InputComponent.new(
      form: form,
      field: :category_id,
      label: "Category",
      type: :select,
      collection: current_user.categories.map { |c| [c.name, c.id] },
      include_blank: "Select category"
    ) %>
  </div>

  <div data-transfer-toggle-target="destinationField" class="<%= 'hidden' unless transaction.transfer? %>">
    <%= render InputComponent.new(
      form: form,
      field: :destination_account_id,
      label: "To Account",
      type: :select,
      collection: current_user.accounts.active.ordered.map { |a| [a.name, a.id] },
      include_blank: "Select destination account"
    ) %>
  </div>

  <%# Tag picker %>
  <div data-controller="tag-select" data-action="click@window->tag-select#closeOnClickOutside">
    <label class="block text-sm font-medium text-text-primary mb-1.5">Tags</label>
    <div class="relative">
      <button type="button" data-action="click->tag-select#toggle"
        class="block w-full rounded-xl border border-input-border px-4 py-2.5 text-sm glass text-left focus:outline-none focus:ring-2 focus:ring-input-focus">
        <span data-tag-select-target="display" class="<%= transaction.tags.any? ? 'text-text-primary' : 'text-text-muted' %>">
          <%= transaction.tags.any? ? transaction.tags.map(&:name).join(", ") : "Select tags..." %>
        </span>
      </button>
      <div data-tag-select-target="menu" class="hidden absolute z-50 mt-1 w-full bg-surface rounded-xl shadow-xl border border-border p-2 max-h-48 overflow-y-auto">
        <% current_user.tags.order(:name).each do |tag| %>
          <%= render CheckboxComponent.new(
            name: "transaction[tag_ids][]",
            value: tag.id.to_s,
            checked: transaction.tags.include?(tag),
            size: :sm,
            wrapper_class: "items-center px-3 py-2 rounded-lg hover:bg-surface-hover transition-colors",
            data: { tag_select_target: "checkbox", tag_name: tag.name, action: "change->tag-select#update" }
          ) do %>
            <span class="inline-flex items-center gap-1.5">
              <span class="inline-block w-2.5 h-2.5 rounded-full shrink-0" style="background-color: <%= tag.color || '#94a3b8' %>"></span>
              <%= tag.name %>
            </span>
          <% end %>
        <% end %>
        <% if current_user.tags.empty? %>
          <p class="px-3 py-2 text-sm text-text-muted">No tags yet. <%= link_to "Create one", new_tag_path, class: "text-primary-600 hover:underline", data: { turbo_frame: "modal" } %></p>
        <% end %>
      </div>
    </div>
  </div>

  <%# Flag selector %>
  <div>
    <label class="block text-sm font-medium text-text-primary mb-1.5">Flag</label>
    <div class="flex items-center gap-2">
      <% Transaction.flags.keys.each do |flag_name| %>
        <% colors = Transaction::FLAG_COLORS[flag_name] %>
        <label class="cursor-pointer">
          <%= form.radio_button :flag, flag_name, class: "hidden peer" %>
          <span class="inline-flex items-center justify-center w-8 h-8 rounded-lg border-2 transition-all
            peer-checked:border-current peer-checked:scale-110
            <%= colors[:bg] %> <%= colors[:text] %> border-transparent hover:border-current/30">
            <%= heroicon "flag", variant: :mini, options: { class: "w-4 h-4" } %>
          </span>
        </label>
      <% end %>
      <label class="cursor-pointer">
        <%= form.radio_button :flag, "", class: "hidden peer", checked: transaction.flag.nil? %>
        <span class="inline-flex items-center justify-center w-8 h-8 rounded-lg border-2 border-transparent transition-all
          peer-checked:border-text-muted peer-checked:scale-110
          bg-surface-hover text-text-muted hover:border-text-muted/30">
          <%= heroicon "x-mark", variant: :mini, options: { class: "w-4 h-4" } %>
        </span>
      </label>
    </div>
  </div>

  <%# Split Transactions %>
  <div>
    <button type="button" data-action="click->split-transaction#toggle"
      class="inline-flex items-center gap-2 text-sm font-medium text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 transition-colors">
      <%= heroicon "scissors", variant: :mini, options: { class: "w-4 h-4" } %>
      <span>Split Transaction</span>
    </button>

    <div data-split-transaction-target="splitSection" class="<%= transaction.split? ? '' : 'hidden' %> mt-3 space-y-3 p-4 rounded-xl glass border border-glass-border">
      <div class="flex items-center justify-between">
        <label class="block text-sm font-medium text-text-primary">Split Categories</label>
        <span class="text-xs text-text-muted">Total: <span data-split-transaction-target="total">$0.00</span></span>
      </div>

      <div data-split-transaction-target="container" class="space-y-2">
        <% transaction.transaction_splits.each do |split| %>
          <div data-split-row class="flex items-center gap-2">
            <%= form.fields_for :transaction_splits, split do |sf| %>
              <%= sf.hidden_field :id %>
              <input type="hidden" name="<%= sf.object_name %>[_destroy]" value="0">
              <%= sf.select :category_id,
                options_for_select(current_user.categories.map { |c| [ c.name, c.id ] }, split.category_id),
                { include_blank: "Category" },
                class: "flex-1 rounded-lg glass border border-glass-border text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30" %>
              <%= sf.number_field :amount, step: "0.01", min: "0.01", placeholder: "Amount",
                data: { action: "input->split-transaction#updateTotal" },
                class: "w-28 rounded-lg glass border border-glass-border text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30" %>
              <%= sf.text_field :memo, placeholder: "Memo",
                class: "w-32 rounded-lg glass border border-glass-border text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30" %>
            <% end %>
            <button type="button" data-action="click->split-transaction#removeRow"
              class="p-1.5 rounded-lg hover:bg-danger-50 dark:hover:bg-danger-500/10 text-text-muted hover:text-danger-600 transition-all shrink-0">
              <%= heroicon "x-mark", variant: :mini, options: { class: "w-4 h-4" } %>
            </button>
          </div>
        <% end %>
      </div>

      <template data-split-transaction-target="template">
        <div data-split-row class="flex items-center gap-2">
          <select name="transaction[transaction_splits_attributes][NEW_RECORD][category_id]"
            class="flex-1 rounded-lg glass border border-glass-border text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30">
            <option value="">Category</option>
            <% current_user.categories.each do |c| %>
              <option value="<%= c.id %>"><%= c.name %></option>
            <% end %>
          </select>
          <input type="number" name="transaction[transaction_splits_attributes][NEW_RECORD][amount]"
            step="0.01" min="0.01" placeholder="Amount"
            data-action="input->split-transaction#updateTotal"
            class="w-28 rounded-lg glass border border-glass-border text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30">
          <input type="text" name="transaction[transaction_splits_attributes][NEW_RECORD][memo]"
            placeholder="Memo"
            class="w-32 rounded-lg glass border border-glass-border text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30">
          <button type="button" data-action="click->split-transaction#removeRow"
            class="p-1.5 rounded-lg hover:bg-danger-50 dark:hover:bg-danger-500/10 text-text-muted hover:text-danger-600 transition-all shrink-0">
            <%= heroicon "x-mark", variant: :mini, options: { class: "w-4 h-4" } %>
          </button>
        </div>
      </template>

      <button type="button" data-action="click->split-transaction#addRow"
        class="inline-flex items-center gap-1.5 text-xs font-medium text-primary-600 dark:text-primary-400 hover:text-primary-700 transition-colors">
        <%= heroicon "plus", variant: :mini, options: { class: "w-3.5 h-3.5" } %>
        Add Split
      </button>
    </div>
  </div>

  <%# Contra Category (Accounting Mode) %>
  <% if current_user.preference.accounting_mode? %>
    <%= render InputComponent.new(
      form: form,
      field: :contra_category_id,
      label: "Contra Category (Debit/Credit Offset)",
      type: :select,
      collection: current_user.categories.map { |c| [ c.name, c.id ] },
      include_blank: "None (single-entry)"
    ) %>
  <% end %>

  <%# Dynamic Custom Fields %>
  <% custom_field_definitions = current_user.custom_field_definitions.ordered %>
  <% if custom_field_definitions.any? %>
    <div class="space-y-4 p-4 rounded-xl glass border border-glass-border">
      <p class="text-xs font-medium text-text-secondary uppercase tracking-wide">Custom Fields</p>
      <div class="space-y-3">
        <% custom_field_definitions.each do |field_def| %>
          <% field_key = field_def.id.to_s %>
          <% field_value = transaction.custom_fields&.dig(field_key) %>
          <div>
            <label class="block text-sm font-medium text-text-primary mb-1.5"><%= field_def.name %></label>
            <% case field_def.field_type %>
            <% when "text" %>
              <input type="text" name="transaction[custom_fields][<%= field_key %>]" value="<%= field_value %>"
                class="block w-full rounded-xl border border-input-border px-4 py-2.5 text-sm glass text-text-primary placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-input-focus transition-all duration-200"
                placeholder="Enter <%= field_def.name.downcase %>">
            <% when "number" %>
              <input type="number" name="transaction[custom_fields][<%= field_key %>]" value="<%= field_value %>" step="any"
                class="block w-full rounded-xl border border-input-border px-4 py-2.5 text-sm glass text-text-primary placeholder:text-text-muted focus:outline-none focus:ring-2 focus:ring-input-focus transition-all duration-200"
                placeholder="Enter <%= field_def.name.downcase %>">
            <% when "date" %>
              <input type="date" name="transaction[custom_fields][<%= field_key %>]" value="<%= field_value %>"
                class="block w-full rounded-xl border border-input-border px-4 py-2.5 text-sm glass text-text-primary focus:outline-none focus:ring-2 focus:ring-input-focus transition-all duration-200">
            <% when "boolean" %>
              <div class="flex items-center gap-2">
                <input type="hidden" name="transaction[custom_fields][<%= field_key %>]" value="false">
                <input type="checkbox" name="transaction[custom_fields][<%= field_key %>]" value="true"
                  <%= "checked" if field_value == "true" %>
                  class="rounded border-input-border text-primary-600 focus:ring-primary-500 focus:ring-offset-0">
                <span class="text-sm text-text-secondary">Yes</span>
              </div>
            <% when "select" %>
              <select name="transaction[custom_fields][<%= field_key %>]"
                class="block w-full rounded-xl border border-input-border px-4 py-2.5 text-sm glass text-text-primary focus:outline-none focus:ring-2 focus:ring-input-focus transition-all duration-200">
                <option value="">Select...</option>
                <% field_def.select_choices.each do |choice| %>
                  <option value="<%= choice %>" <%= "selected" if field_value == choice %>><%= choice %></option>
                <% end %>
              </select>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%= render InputComponent.new(
    form: form,
    field: :clearing_status,
    label: "Clearing Status",
    type: :select,
    collection: Transaction.clearing_statuses.keys.map { |s| [ s.humanize, s ] },
    include_blank: false
  ) %>

  <%= render InputComponent.new(form: form, field: :notes, label: "Notes", type: :textarea, placeholder: "Optional notes...", rows: 3) %>

  <%# Receipt/Attachment Upload %>
  <div data-controller="receipt-upload">
    <label class="block text-sm font-medium text-text-primary mb-1.5">Receipts / Attachments</label>

    <% if transaction.persisted? && transaction.receipts.attached? %>
      <div class="flex flex-wrap gap-2 mb-3">
        <% transaction.receipts.each do |receipt| %>
          <div class="relative group rounded-xl overflow-hidden border border-glass-border glass w-20 h-20 flex items-center justify-center">
            <% if receipt.content_type.start_with?("image/") %>
              <%= image_tag url_for(receipt), class: "w-full h-full object-cover" %>
            <% else %>
              <div class="flex flex-col items-center gap-1">
                <%= heroicon "document", variant: :outline, options: { class: "w-8 h-8 text-danger-500" } %>
                <span class="text-[9px] text-text-muted font-medium">PDF</span>
              </div>
            <% end %>
            <div class="absolute bottom-0 left-0 right-0 bg-black/60 text-white text-[8px] px-1 py-0.5 truncate text-center"><%= receipt.filename %></div>
            <%= button_to remove_receipt_transaction_path(transaction, receipt_id: receipt.id), method: :delete,
              class: "absolute -top-0.5 -right-0.5 w-5 h-5 rounded-full bg-danger-500 text-white flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity shadow-sm",
              data: { turbo_confirm: "Remove this receipt?" } do %>
              <%= heroicon "x-mark", variant: :mini, options: { class: "w-3 h-3" } %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <div data-receipt-upload-target="dropZone"
         data-action="click->receipt-upload#selectFiles"
         class="border-2 border-dashed border-glass-border rounded-xl p-4 text-center cursor-pointer hover:border-primary-500/50 transition-colors">
      <div class="flex flex-col items-center gap-2">
        <%= heroicon "cloud-arrow-up", variant: :outline, options: { class: "w-8 h-8 text-text-muted" } %>
        <p class="text-sm text-text-secondary">
          <span class="font-medium text-primary-600 dark:text-primary-400">Click to upload</span> or drag and drop
        </p>
        <p class="text-xs text-text-muted">JPEG, PNG, WebP, or PDF (max 10MB, up to 5 files)</p>
        <span data-receipt-upload-target="fileCount" class="text-xs font-medium text-primary-600 dark:text-primary-400"></span>
      </div>
    </div>
    <%= form.file_field :receipts, multiple: true, accept: "image/jpeg,image/png,image/webp,application/pdf",
      class: "hidden", data: { receipt_upload_target: "input", action: "change->receipt-upload#handleFileSelect" } %>
    <p data-receipt-upload-target="errorMessage" class="hidden mt-1 text-xs text-danger-600"></p>
    <div data-receipt-upload-target="preview" class="flex flex-wrap gap-2 mt-3"></div>
  </div>

  <%= render ButtonComponent.new(variant: :primary, type: "submit", submit: true) do %>
    <%= transaction.persisted? ? "Update Transaction" : "Create Transaction" %>
  <% end %>
<% end %>
