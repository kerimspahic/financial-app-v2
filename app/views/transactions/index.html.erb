<% q_params = params[:q].present? ? params[:q].to_unsafe_h : {} %>
<% filter_params = q_params.except("s") %>
<% has_active_filters = filter_params.values.any?(&:present?) %>
<% enabled_filters = @table_config.enabled_filters %>

<div class="space-y-5">
  <%= render PageHeaderComponent.new(title: "Transactions") do |header| %>
    <% header.with_actions do %>
      <%= render ButtonComponent.new(variant: :primary, href: new_transaction_path, icon: "plus", data: { turbo_frame: "modal" }) do %>
        New Transaction
      <% end %>
    <% end %>
  <% end %>

  <%= turbo_frame_tag "transactions_content", data: { turbo_action: "advance" } do %>
    <div class="space-y-5">
    <%# ── Unified Search + Filter Toolbar ── %>
    <div class="animate-card-entrance stagger-1">
      <div class="glass rounded-2xl shadow-lg relative p-6 z-10">
        <div class="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent pointer-events-none rounded-2xl"></div>
        <div class="relative space-y-3" data-controller="filter-panel" data-filter-panel-open-value="<%= has_active_filters %>">
          <%# Top Row: Search + Quick Actions %>
          <div class="flex items-center gap-3">
            <%# Search Bar %>
            <div class="flex-1" data-controller="table-search" data-table-search-debounce-value="<%= AppSetting.get('search_debounce', default: '600') %>">
              <%= form_with url: transactions_path, method: :get, data: { table_search_target: "form", turbo_frame: "transactions_content" } do %>
                <% if q_params.any? %>
                  <% q_params.each do |key, value| %>
                    <% if value.present? %>
                      <input type="hidden" name="q[<%= key %>]" value="<%= value %>">
                    <% end %>
                  <% end %>
                <% end %>
                <div class="relative group">
                  <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                    <%= heroicon "magnifying-glass", variant: :outline, options: { class: "w-4 h-4 text-text-muted group-focus-within:text-primary-500 transition-colors" } %>
                  </div>
                  <input type="text" name="search" value="<%= params[:search] %>"
                    placeholder="Search by description, notes, category, account..."
                    autocomplete="off"
                    data-table-search-target="input"
                    data-action="input->table-search#search"
                    class="block w-full pl-10 pr-10 py-2 rounded-xl glass text-text-primary placeholder-text-muted text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 border border-glass-border transition-all">
                  <% if params[:search].present? %>
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                      <%= link_to transactions_path(q: q_params), class: "text-text-muted hover:text-text-primary transition-colors", data: { turbo_frame: "transactions_content" } do %>
                        <%= heroicon "x-circle", variant: :mini, options: { class: "w-4 h-4" } %>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>

            <%# Filter Toggle %>
            <% if enabled_filters.any? %>
              <button type="button" data-action="click->filter-panel#toggle"
                class="relative flex items-center gap-2 px-3.5 py-2 text-sm rounded-xl border transition-all
                  <%= has_active_filters ? 'glass-strong border-primary-500/30 text-primary-600 dark:text-primary-400' : 'glass border-glass-border text-text-secondary hover:text-text-primary' %>">
                <%= heroicon "funnel", variant: :outline, options: { class: "w-4 h-4" } %>
                <span class="hidden sm:inline">Filters</span>
                <% if has_active_filters %>
                  <% active_count = filter_params.values.count(&:present?) %>
                  <span class="flex items-center justify-center w-5 h-5 text-[10px] font-bold rounded-full gradient-primary text-white"><%= active_count %></span>
                <% end %>
              </button>
            <% end %>

            <%# Column Visibility %>
            <div data-controller="column-toggle"
                 data-column-toggle-columns-value="<%= @table_config.columns.to_json %>"
                 data-column-toggle-visible-value="<%= @visible_columns.to_json %>"
                 data-column-toggle-url-value="<%= table_preferences_path %>">
              <div class="relative" data-controller="dropdown">
                <button type="button" data-action="dropdown#toggle"
                  class="flex items-center gap-2 px-3.5 py-2 text-sm rounded-xl glass border border-glass-border text-text-secondary hover:text-text-primary transition-all">
                  <%= heroicon "view-columns", variant: :outline, options: { class: "w-4 h-4" } %>
                  <span class="hidden sm:inline">Columns</span>
                </button>
                <div data-dropdown-target="menu" class="hidden absolute right-0 mt-2 w-52 bg-surface rounded-xl shadow-xl border border-border z-50 p-1.5">
                  <p class="px-3 py-1.5 text-[10px] font-semibold text-text-muted uppercase tracking-wider">Toggle Columns</p>
                  <% (@table_config.columns || []).each do |col| %>
                    <%= render CheckboxComponent.new(
                      value: col["key"],
                      checked: @visible_columns.include?(col["key"]),
                      label: col["label"],
                      size: :sm,
                      wrapper_class: "items-center px-3 py-2 rounded-lg hover:bg-surface-hover transition-colors",
                      data: { action: "change->column-toggle#toggle" }
                    ) %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>

          <%# Expandable Filter Panel %>
          <% if enabled_filters.any? %>
            <div>
              <div data-filter-panel-target="panel" class="<%= 'hidden' unless has_active_filters %> pt-3 border-t border-glass-border">
                <%= search_form_for @q, url: transactions_path, html: { method: :get, data: { turbo_frame: "transactions_content" }, class: "space-y-3" } do |f| %>
                  <% if params[:search].present? %>
                    <input type="hidden" name="search" value="<%= params[:search] %>">
                  <% end %>

                  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3">
                    <% enabled_filters.each do |filter| %>
                      <% case filter["key"] %>
                      <% when "transaction_type" %>
                        <div>
                          <label class="block text-[10px] font-semibold text-text-muted uppercase tracking-wider mb-1.5"><%= filter["label"] %></label>
                          <%= f.select :transaction_type_eq,
                            options_for_select([["All Types", nil], ["Income", "income"], ["Expense", "expense"], ["Transfer", "transfer"]], q_params["transaction_type_eq"]),
                            {},
                            class: "block w-full rounded-lg glass border border-glass-border text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all" %>
                        </div>
                      <% when "account_id" %>
                        <div>
                          <label class="block text-[10px] font-semibold text-text-muted uppercase tracking-wider mb-1.5"><%= filter["label"] %></label>
                          <%= f.select :account_id_eq,
                            options_for_select([["All Accounts", nil]] + current_user.accounts.pluck(:name, :id), q_params["account_id_eq"]),
                            {},
                            class: "block w-full rounded-lg glass border border-glass-border text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all" %>
                        </div>
                      <% when "category_id" %>
                        <div>
                          <label class="block text-[10px] font-semibold text-text-muted uppercase tracking-wider mb-1.5"><%= filter["label"] %></label>
                          <%= f.select :category_id_eq,
                            options_for_select([["All Categories", nil]] + current_user.categories.pluck(:name, :id), q_params["category_id_eq"]),
                            {},
                            class: "block w-full rounded-lg glass border border-glass-border text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all" %>
                        </div>
                      <% when "date" %>
                        <div>
                          <label class="block text-[10px] font-semibold text-text-muted uppercase tracking-wider mb-1.5">From</label>
                          <%= f.date_field :date_gteq, value: q_params["date_gteq"],
                            class: "block w-full rounded-lg glass border border-glass-border text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all" %>
                        </div>
                        <div>
                          <label class="block text-[10px] font-semibold text-text-muted uppercase tracking-wider mb-1.5">To</label>
                          <%= f.date_field :date_lteq, value: q_params["date_lteq"],
                            class: "block w-full rounded-lg glass border border-glass-border text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all" %>
                        </div>
                      <% when "amount" %>
                        <div>
                          <label class="block text-[10px] font-semibold text-text-muted uppercase tracking-wider mb-1.5">Min Amount</label>
                          <%= f.number_field :amount_gteq, value: q_params["amount_gteq"], step: 0.01, placeholder: "$0",
                            class: "block w-full rounded-lg glass border border-glass-border text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all" %>
                        </div>
                        <div>
                          <label class="block text-[10px] font-semibold text-text-muted uppercase tracking-wider mb-1.5">Max Amount</label>
                          <%= f.number_field :amount_lteq, value: q_params["amount_lteq"], step: 0.01, placeholder: "Any",
                            class: "block w-full rounded-lg glass border border-glass-border text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30 focus:border-primary-500 transition-all" %>
                        </div>
                      <% end %>
                    <% end %>
                  </div>

                  <div class="flex items-center justify-between pt-2">
                    <%# Active Filter Chips %>
                    <div class="flex items-center gap-2 flex-wrap">
                      <%# Sort chip %>
                      <% if q_params["s"].present? %>
                        <% sort_parts = q_params["s"].split(" ") %>
                        <% sort_col_key = sort_parts.first %>
                        <% sort_dir = sort_parts.last %>
                        <% sort_col_label = @table_config.columns&.find { |c| (c["sort_key"] || c["key"]) == sort_col_key }&.dig("label") || sort_col_key.humanize %>
                        <% sort_arrow = sort_dir == "desc" ? "↓" : "↑" %>
                        <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium glass-strong border border-glass-border text-text-secondary">
                          <%= heroicon "bars-arrow-down", variant: :mini, options: { class: "w-3 h-3" } %>
                          Sort: <%= sort_col_label %> <%= sort_arrow %>
                          <%= link_to transactions_path(q: q_params.except("s"), search: params[:search]),
                            class: "ml-0.5 hover:text-danger-500 transition-colors",
                            data: { turbo_frame: "transactions_content" } do %>
                            <%= heroicon "x-mark", variant: :mini, options: { class: "w-3 h-3" } %>
                          <% end %>
                        </span>
                      <% end %>
                      <%# Filter chips %>
                      <% if has_active_filters %>
                        <% filter_params.each do |key, value| %>
                          <% next unless value.present? %>
                          <% label = case key
                            when "transaction_type_eq" then "Type: #{value.humanize}"
                            when "account_id_eq" then "Account: #{current_user.accounts.find_by(id: value)&.name || value}"
                            when "category_id_eq" then "Category: #{current_user.categories.find_by(id: value)&.name || value}"
                            when "date_gteq" then "From: #{Date.parse(value).strftime('%b %d')}"
                            when "date_lteq" then "To: #{Date.parse(value).strftime('%b %d')}"
                            when "amount_gteq" then "Min: $#{value}"
                            when "amount_lteq" then "Max: $#{value}"
                            else "#{key}: #{value}"
                            end
                          %>
                          <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-xs font-medium glass-strong border border-primary-500/20 text-primary-600 dark:text-primary-400">
                            <%= label %>
                            <% new_params = q_params.except(key) %>
                            <%= link_to transactions_path(q: new_params, search: params[:search]),
                              class: "ml-0.5 hover:text-danger-500 transition-colors",
                              data: { turbo_frame: "transactions_content" } do %>
                              <%= heroicon "x-mark", variant: :mini, options: { class: "w-3 h-3" } %>
                            <% end %>
                          </span>
                        <% end %>
                      <% end %>
                    </div>

                    <div class="flex items-center gap-2 shrink-0">
                      <% if has_active_filters %>
                        <%= link_to transactions_path(search: params[:search]),
                          class: "text-xs text-text-muted hover:text-danger-500 transition-colors",
                          data: { turbo_frame: "transactions_content" } do %>
                          Clear all
                        <% end %>
                      <% end %>
                      <%= render ButtonComponent.new(variant: :primary, type: "submit", size: :sm) do %>
                        Apply Filters
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>

          <%# Saved Filters %>
          <div id="saved_filters">
            <%= render partial: "transactions/saved_filters", locals: { saved_filters: @saved_filters } %>
          </div>
        </div>
      </div>
    </div>

    <%# ── Transaction Table ── %>
    <% if @transactions.any? %>
      <div class="animate-card-entrance stagger-3" data-controller="bulk-select">
        <%= form_tag "#", method: :post, data: { bulk_select_target: "form", bulk_update_url: bulk_update_transactions_path, bulk_destroy_url: bulk_destroy_transactions_path } do %>
        <%= render CardComponent.new(padding: false) do %>
          <div class="overflow-hidden">
            <%
              col_widths = {
                "date" => "w-[100px]",
                "description" => "w-auto",
                "category" => "w-[130px]",
                "account" => "w-[140px]",
                "amount" => "w-[110px]",
                "transaction_type" => "w-[100px]",
                "clearing_status" => "w-[100px]",
                "notes" => "w-[180px]",
                "tags" => "w-[160px]",
                "balance" => "w-[120px]"
              }
            %>
            <table class="w-full table-fixed">
              <thead>
                <tr class="border-b border-glass-border">
                  <th class="px-3 py-3 w-[40px]">
                    <input type="checkbox" data-bulk-select-target="selectAll" data-action="change->bulk-select#toggleAll"
                      class="w-3.5 h-3.5 rounded">
                  </th>
                  <% (@table_config.columns || []).each do |col| %>
                    <% next unless @visible_columns.include?(col["key"]) %>
                    <th class="px-5 py-3 text-<%= %w[amount balance].include?(col["key"]) ? "right" : "left" %> text-[10px] font-semibold text-text-muted uppercase tracking-wider whitespace-nowrap <%= col_widths[col["key"]] %>" data-column="<%= col["key"] %>">
                      <% if col["sortable"] %>
                        <% sort_key = (col["sort_key"] || col["key"]).to_sym %>
                        <%= sort_link(@q, sort_key, col["label"], default_order: col["key"] == "date" ? :desc : :asc, hide_indicator: false) %>
                      <% else %>
                        <%= col["label"] %>
                      <% end %>
                    </th>
                  <% end %>
                  <th class="px-5 py-3 text-right text-[10px] font-semibold text-text-muted uppercase tracking-wider w-[70px]"></th>
                </tr>
              </thead>
              <tbody class="divide-y divide-glass-border/50">
                <% @transactions.each do |t| %>
                  <tr class="group hover:bg-surface-hover/50 transition-colors">
                    <td class="px-3 py-3.5">
                      <input type="checkbox" value="<%= t.id %>" data-bulk-select-target="checkbox" data-action="change->bulk-select#toggleOne"
                        class="w-3.5 h-3.5 rounded">
                    </td>
                    <% (@table_config.columns || []).each do |col| %>
                      <% next unless @visible_columns.include?(col["key"]) %>
                      <% case col["key"] %>
                      <% when "date" %>
                        <td class="px-5 py-3.5 whitespace-nowrap" data-column="date">
                          <div class="flex flex-col">
                            <span class="text-sm font-medium text-text-primary"><%= t.date.strftime("%b %d") %></span>
                            <span class="text-[10px] text-text-muted"><%= t.date.strftime("%Y") %></span>
                          </div>
                        </td>
                      <% when "description" %>
                        <td class="px-5 py-3.5 overflow-hidden" data-column="description">
                          <div class="flex items-center gap-3 min-w-0">
                            <div class="flex-shrink-0 w-8 h-8 rounded-lg flex items-center justify-center
                              <%= t.income? ? 'bg-success-50 dark:bg-success-500/10' : (t.transfer? ? 'bg-info-50 dark:bg-info-500/10' : 'bg-danger-50 dark:bg-danger-500/10') %>">
                              <%= heroicon(
                                t.income? ? "arrow-down-left" : (t.transfer? ? "arrow-path" : "arrow-up-right"),
                                variant: :mini,
                                options: { class: "w-4 h-4 #{t.income? ? 'text-success-600 dark:text-success-500' : (t.transfer? ? 'text-info-600 dark:text-info-500' : 'text-danger-600 dark:text-danger-500')}" }
                              ) %>
                            </div>
                            <div class="min-w-0 flex-1" data-controller="tooltip" data-tooltip-text-value="<%= t.description %><%= t.notes.present? ? "\n#{t.notes}" : '' %>">
                              <%= link_to t.description, transaction_path(t),
                                class: "text-sm font-medium text-text-primary hover:text-primary-600 transition-colors truncate block",
                                data: { turbo_frame: "modal" } %>
                              <% if t.notes.present? %>
                                <p class="text-[10px] text-text-muted truncate"><%= t.notes %></p>
                              <% end %>
                            </div>
                          </div>
                        </td>
                      <% when "category" %>
                        <td class="px-5 py-3.5 overflow-hidden" data-column="category">
                          <% if t.split? %>
                            <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md text-xs font-medium glass border border-glass-border text-text-secondary max-w-full"
                              data-controller="tooltip" data-tooltip-text-value="<%= t.transaction_splits.map { |s| "#{s.category.name}: #{number_to_currency(s.amount)}" }.join(', ') %>">
                              <%= heroicon "scissors", variant: :mini, options: { class: "w-3.5 h-3.5 shrink-0" } %>
                              <span class="truncate">Split (<%= t.transaction_splits.size %>)</span>
                            </span>
                          <% else %>
                            <span class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-md text-xs font-medium glass border border-glass-border text-text-secondary max-w-full"
                              data-controller="tooltip" data-tooltip-text-value="<%= t.category.name %>">
                              <span class="w-1.5 h-1.5 rounded-full shrink-0" style="background-color: <%= t.category.color %>"></span>
                              <span class="truncate"><%= t.category.name %></span>
                            </span>
                          <% end %>
                        </td>
                      <% when "account" %>
                        <td class="px-5 py-3.5 overflow-hidden" data-column="account">
                          <span class="text-sm text-text-secondary truncate block"
                            data-controller="tooltip" data-tooltip-text-value="<%= t.account.name %>"><%= t.account.name %></span>
                        </td>
                      <% when "amount" %>
                        <td class="px-5 py-3.5 whitespace-nowrap text-right" data-column="amount">
                          <span class="text-sm font-semibold tabular-nums <%= amount_color_class(t) %>">
                            <%= formatted_amount(t) %>
                          </span>
                        </td>
                      <% when "transaction_type" %>
                        <td class="px-5 py-3.5 whitespace-nowrap" data-column="transaction_type">
                          <%= render BadgeComponent.new(
                            variant: t.income? ? :success : (t.expense? ? :danger : :info),
                            size: :sm,
                            dot: true
                          ) do %>
                            <%= t.transaction_type.humanize %>
                          <% end %>
                        </td>
                      <% when "clearing_status" %>
                        <td class="px-5 py-3.5 whitespace-nowrap" data-column="clearing_status">
                          <% case t.clearing_status %>
                          <% when "uncleared" %>
                            <span class="inline-flex items-center gap-1 text-xs text-text-muted">
                              <%= heroicon "minus-circle", variant: :mini, options: { class: "w-4 h-4" } %>
                              Uncleared
                            </span>
                          <% when "cleared" %>
                            <span class="inline-flex items-center gap-1 text-xs text-success-600 dark:text-success-500">
                              <%= heroicon "check", variant: :mini, options: { class: "w-4 h-4" } %>
                              Cleared
                            </span>
                          <% when "reconciled" %>
                            <span class="inline-flex items-center gap-1 text-xs text-primary-600 dark:text-primary-400">
                              <%= heroicon "check-badge", variant: :mini, options: { class: "w-4 h-4" } %>
                              Reconciled
                            </span>
                          <% end %>
                        </td>
                      <% when "notes" %>
                        <td class="px-5 py-3.5 overflow-hidden" data-column="notes">
                          <span class="text-sm text-text-muted truncate block"
                            data-controller="tooltip" data-tooltip-text-value="<%= t.notes %>"
                            ><%= t.notes.presence || "\u2014" %></span>
                        </td>
                      <% when "tags" %>
                        <td class="px-5 py-3.5 overflow-hidden" data-column="tags">
                          <div class="flex flex-nowrap gap-1 overflow-hidden"
                            data-controller="tooltip" data-tooltip-text-value="<%= t.tags.map(&:name).join(', ') %>">
                            <% t.tags.each do |tag| %>
                              <span class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded text-[10px] font-medium border" style="background-color: <%= tag.color %>15; border-color: <%= tag.color %>30; color: <%= tag.color %>">
                                <span class="w-1.5 h-1.5 rounded-full" style="background-color: <%= tag.color %>"></span>
                                <%= tag.name %>
                              </span>
                            <% end %>
                            <% if t.tags.empty? %>
                              <span class="text-xs text-text-muted">&mdash;</span>
                            <% end %>
                          </div>
                        </td>
                      <% when "balance" %>
                        <td class="px-5 py-3.5 whitespace-nowrap text-right" data-column="balance">
                          <% if @running_balances&.key?(t.id) %>
                            <span class="text-sm font-medium tabular-nums <%= @running_balances[t.id] >= 0 ? 'text-text-primary' : 'text-danger-600' %>">
                              <%= number_to_currency(@running_balances[t.id]) %>
                            </span>
                          <% else %>
                            <span class="text-xs text-text-muted">&mdash;</span>
                          <% end %>
                        </td>
                      <% end %>
                    <% end %>
                    <td class="px-5 py-3.5 text-right whitespace-nowrap">
                      <% if t.reconciled? %>
                        <div class="flex items-center justify-end gap-1 text-text-muted">
                          <%= heroicon "lock-closed", variant: :mini, options: { class: "w-4 h-4" } %>
                          <span class="text-[10px] font-medium">Locked</span>
                        </div>
                      <% else %>
                        <div class="opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-end gap-1">
                          <%= link_to transaction_path(t), class: "p-1.5 rounded-lg hover:bg-surface-hover text-text-muted hover:text-text-primary transition-all", data: { turbo_frame: "modal" } do %>
                            <%= heroicon "eye", variant: :mini, options: { class: "w-4 h-4" } %>
                          <% end %>
                          <%= link_to edit_transaction_path(t), class: "p-1.5 rounded-lg hover:bg-surface-hover text-text-muted hover:text-primary-600 transition-all", data: { turbo_frame: "modal" } do %>
                            <%= heroicon "pencil-square", variant: :mini, options: { class: "w-4 h-4" } %>
                          <% end %>
                        </div>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>

        <%# ── Bulk Actions Floating Toolbar ── %>
        <div data-bulk-select-target="toolbar" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 z-50">
          <div class="glass-strong rounded-2xl shadow-2xl border border-glass-border px-6 py-3 flex items-center gap-4">
            <span class="text-sm font-medium text-text-primary" data-bulk-select-target="count">0 selected</span>
            <div class="h-5 w-px bg-glass-border"></div>
            <div class="flex items-center gap-2">
              <select name="bulk_category_id" class="rounded-lg glass border border-glass-border text-text-primary px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30">
                <option value="">Change Category</option>
                <% current_user.categories.each do |c| %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% end %>
              </select>
              <select name="bulk_clearing_status" class="rounded-lg glass border border-glass-border text-text-primary px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500/30">
                <option value="">Change Status</option>
                <% Transaction.clearing_statuses.keys.each do |s| %>
                  <option value="<%= s %>"><%= s.humanize %></option>
                <% end %>
              </select>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" data-action="click->bulk-select#submitBulkUpdate"
                class="inline-flex items-center gap-1.5 px-4 py-1.5 text-sm font-medium rounded-lg gradient-primary text-white shadow-sm hover:shadow-md transition-all">
                <%= heroicon "check", variant: :mini, options: { class: "w-4 h-4" } %>
                Apply
              </button>
              <button type="button" data-action="click->bulk-select#submitBulkDestroy"
                class="inline-flex items-center gap-1.5 px-4 py-1.5 text-sm font-medium rounded-lg bg-danger-500 hover:bg-danger-600 text-white shadow-sm hover:shadow-md transition-all">
                <%= heroicon "trash", variant: :mini, options: { class: "w-4 h-4" } %>
                Delete
              </button>
            </div>
          </div>
        </div>
        <% end %>
      </div>

      <%# ── Pagination ── %>
      <% if @pagy.pages > 1 %>
        <div class="animate-card-entrance stagger-4">
          <div class="flex items-center justify-between">
            <p class="text-xs text-text-muted">
              Showing <span class="font-medium text-text-secondary"><%= @pagy.from %></span>&ndash;<span class="font-medium text-text-secondary"><%= @pagy.to %></span> of
              <span class="font-medium text-text-secondary"><%= @pagy.count %></span>
            </p>
            <nav class="flex items-center gap-1" aria-label="Pagination">
              <% if @pagy.previous %>
                <%= link_to url_for(page: @pagy.previous),
                  class: "p-2 rounded-lg glass border border-glass-border text-text-secondary hover:text-text-primary transition-all",
                  data: { turbo_frame: "transactions_content" } do %>
                  <%= heroicon "chevron-left", variant: :mini, options: { class: "w-4 h-4" } %>
                <% end %>
              <% else %>
                <span class="p-2 rounded-lg text-text-muted/30 cursor-not-allowed">
                  <%= heroicon "chevron-left", variant: :mini, options: { class: "w-4 h-4" } %>
                </span>
              <% end %>

              <% (1..@pagy.pages).each do |page_num| %>
                <% if page_num == @pagy.page %>
                  <span class="w-9 h-9 flex items-center justify-center text-sm font-semibold rounded-lg gradient-primary text-white shadow-sm"><%= page_num %></span>
                <% elsif page_num == 1 || page_num == @pagy.pages || (page_num >= @pagy.page - 1 && page_num <= @pagy.page + 1) %>
                  <%= link_to page_num, url_for(page: page_num),
                    class: "w-9 h-9 flex items-center justify-center text-sm rounded-lg glass border border-glass-border text-text-secondary hover:text-text-primary transition-all",
                    data: { turbo_frame: "transactions_content" } %>
                <% elsif page_num == 2 || page_num == @pagy.pages - 1 %>
                  <span class="w-9 h-9 flex items-center justify-center text-xs text-text-muted">&hellip;</span>
                <% end %>
              <% end %>

              <% if @pagy.next %>
                <%= link_to url_for(page: @pagy.next),
                  class: "p-2 rounded-lg glass border border-glass-border text-text-secondary hover:text-text-primary transition-all",
                  data: { turbo_frame: "transactions_content" } do %>
                  <%= heroicon "chevron-right", variant: :mini, options: { class: "w-4 h-4" } %>
                <% end %>
              <% else %>
                <span class="p-2 rounded-lg text-text-muted/30 cursor-not-allowed">
                  <%= heroicon "chevron-right", variant: :mini, options: { class: "w-4 h-4" } %>
                </span>
              <% end %>
            </nav>
          </div>
        </div>
      <% end %>
    <% else %>
      <div class="animate-card-entrance stagger-3">
        <%= render CardComponent.new do %>
          <%= render EmptyStateComponent.new(
            title: "No transactions found",
            description: params[:search].present? || has_active_filters ? "Try adjusting your search or filters." : "Add your first transaction to start tracking your finances.",
            icon: "banknotes",
            action_text: "Add Transaction",
            action_url: new_transaction_path,
            action_data: { turbo_frame: "modal" }
          ) %>
        <% end %>
      </div>
    <% end %>
    </div>
  <% end %>
</div>
