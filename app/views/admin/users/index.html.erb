<div class="space-y-6">
  <%= render PageHeaderComponent.new(title: "Admin Panel", subtitle: "Manage users and roles") do |header| %>
    <% header.with_actions do %>
      <%= render ButtonComponent.new(variant: :secondary, href: admin_roles_path, icon: "shield-check") do %>
        Manage Roles
      <% end %>
    <% end %>
  <% end %>

  <%# Summary Stats %>
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
    <div class="animate-card-entrance stagger-1">
      <%= render StatCardComponent.new(
        label: "Total Users",
        value: @pagy.count,
        icon: "users"
      ) %>
    </div>
    <div class="animate-card-entrance stagger-2">
      <%= render StatCardComponent.new(
        label: "Active Users",
        value: User.where(active: true).count,
        icon: "check-circle",
        color: "text-success-600"
      ) %>
    </div>
    <div class="animate-card-entrance stagger-3">
      <%= render StatCardComponent.new(
        label: "Disabled Users",
        value: User.where(active: false).count,
        icon: "x-circle",
        color: "text-danger-600"
      ) %>
    </div>
  </div>

  <%# Search & Filters %>
  <%= render CardComponent.new(padding: false) do %>
    <div class="p-4">
      <%= form_with url: admin_users_path, method: :get, class: "flex flex-wrap gap-4 items-end" do |f| %>
        <div class="flex-1 min-w-[200px]">
          <label class="block text-sm font-medium text-text-primary mb-1">Search</label>
          <input type="text" name="search" value="<%= params[:search] %>"
                 placeholder="Search by name or email..."
                 class="block w-full rounded-xl border border-input-border bg-input-bg text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-input-focus">
        </div>
        <div>
          <label class="block text-sm font-medium text-text-primary mb-1">Status</label>
          <select name="active" class="block rounded-xl border border-input-border bg-input-bg text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-input-focus">
            <option value="">All</option>
            <option value="true" <%= "selected" if params[:active] == "true" %>>Active</option>
            <option value="false" <%= "selected" if params[:active] == "false" %>>Disabled</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-text-primary mb-1">Role</label>
          <select name="role" class="block rounded-xl border border-input-border bg-input-bg text-text-primary px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-input-focus">
            <option value="">All Roles</option>
            <% @roles.each do |role| %>
              <option value="<%= role.name %>" <%= "selected" if params[:role] == role.name %>><%= role.name.humanize %></option>
            <% end %>
          </select>
        </div>
        <%= render ButtonComponent.new(variant: :secondary, type: "submit", submit: true, icon: "funnel") do %>
          Filter
        <% end %>
      <% end %>
    </div>
  <% end %>

  <%# Users Table %>
  <% if @users.any? %>
    <%= render CardComponent.new(padding: false) do %>
      <%= render TableComponent.new(hoverable: true) do |table| %>
        <% table.with_header do %>
          <th class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">User</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Email</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Roles</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Status</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Joined</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-text-secondary uppercase tracking-wider">Actions</th>
        <% end %>
        <% table.with_body do %>
          <% @users.each do |user| %>
            <tr>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center gap-3">
                  <%= render AvatarComponent.new(name: user.email, size: :sm) %>
                  <span class="text-sm font-medium text-text-primary">
                    <%= [ user.first_name, user.last_name ].compact.join(" ").presence || "No name" %>
                  </span>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-text-secondary"><%= user.email %></td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex flex-wrap gap-1">
                  <% user.roles.each do |role| %>
                    <%= render BadgeComponent.new(
                      variant: role.name == "admin" ? :warning : :info,
                      size: :sm
                    ) do %>
                      <%= role.name.humanize %>
                    <% end %>
                  <% end %>
                  <% if user.roles.empty? %>
                    <span class="text-xs text-text-muted">No roles</span>
                  <% end %>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <%= render BadgeComponent.new(
                  variant: user.active? ? :success : :danger,
                  dot: true,
                  size: :sm
                ) do %>
                  <%= user.active? ? "Active" : "Disabled" %>
                <% end %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-text-secondary">
                <%= user.created_at.strftime("%b %d, %Y") %>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                <div class="flex items-center justify-end gap-2">
                  <%= render ButtonComponent.new(variant: :ghost, size: :sm, href: edit_admin_user_path(user), icon: "pencil-square") do %>
                    Edit
                  <% end %>
                  <% unless user == current_user %>
                    <%= render ButtonComponent.new(
                      variant: :ghost,
                      size: :sm,
                      href: toggle_active_admin_user_path(user),
                      method: :patch,
                      icon: user.active? ? "x-circle" : "check-circle",
                      confirm: "Are you sure you want to #{user.active? ? 'disable' : 'enable'} this user?"
                    ) do %>
                      <%= user.active? ? "Disable" : "Enable" %>
                    <% end %>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        <% end %>
      <% end %>
    <% end %>

    <%= render "shared/pagination", pagy: @pagy %>
  <% else %>
    <%= render CardComponent.new do %>
      <%= render EmptyStateComponent.new(
        title: "No users found",
        description: "Try adjusting your search or filters.",
        icon: "users"
      ) %>
    <% end %>
  <% end %>
</div>
