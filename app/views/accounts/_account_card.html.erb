<% colors = account_type_color(account.account_type) %>
<div class="animate-card-entrance stagger-<%= i + 1 %>" data-sortable-id="<%= account.id %>">
  <%= render CardComponent.new(class: "cursor-pointer") do %>
    <div class="flex justify-between items-start">
      <div class="flex items-start gap-3">
        <div class="w-10 h-10 rounded-xl <%= colors[:icon_bg] %> flex items-center justify-center shadow-lg">
          <% if account.icon_emoji.present? %>
            <span class="text-xl leading-none"><%= account.icon_emoji %></span>
          <% else %>
            <%= heroicon account_type_icon(account.account_type), variant: :outline, options: { class: "w-5 h-5 text-white" } %>
          <% end %>
        </div>
        <div>
          <%= link_to account.name, account_path(account),
              data: { turbo_frame: "modal" },
              class: "text-lg font-semibold text-text-primary after:absolute after:inset-0" %>
          <p class="text-xs <%= colors[:text] %> font-medium mt-0.5">
            <%= account.account_type.humanize %>
            <% if account.exclude_from_net_worth? %>
              <span class="ml-1 text-[10px] text-text-muted">(excluded from net worth)</span>
            <% end %>
          </p>
        </div>
      </div>
      <div class="relative z-10 flex items-center gap-1">
        <div data-sortable-handle class="cursor-grab active:cursor-grabbing p-1 rounded-lg hover:bg-surface-hover text-text-muted hover:text-text-primary transition-all">
          <%= heroicon "bars-2", variant: :mini, options: { class: "w-4 h-4" } %>
        </div>
        <%= render ButtonComponent.new(variant: :ghost, size: :sm, href: edit_account_path(account), icon: "pencil", data: { turbo_frame: "modal" }) do %>
          Edit
        <% end %>
        <%= render ButtonComponent.new(variant: :ghost, size: :sm, href: archive_account_path(account), method: :patch, icon: "archive-box", data: { turbo_confirm: "Archive '#{account.name}'?" }) do %>
        <% end %>
      </div>
    </div>

    <p class="mt-4 text-2xl font-bold <%= account.balance >= 0 ? 'text-text-primary' : 'text-danger-600' %>">
      <%= number_to_currency(account.balance) %>
    </p>
    <div class="flex items-baseline gap-2">
      <span class="text-sm text-text-secondary"><%= account.currency %></span>
      <% if (converted = converted_balance_display(account)) %>
        <span class="text-xs text-text-muted"><%= converted %></span>
      <% end %>
    </div>

    <% if (change = @balance_changes&.dig(account.id)) %>
      <div class="flex items-center gap-1 mt-1">
        <%= heroicon(change >= 0 ? "arrow-trending-up" : "arrow-trending-down",
            variant: :mini,
            options: { class: "w-3.5 h-3.5 #{change >= 0 ? 'text-success-500' : 'text-danger-500'}" }) %>
        <span class="text-xs font-semibold <%= change >= 0 ? 'text-success-600' : 'text-danger-600' %>">
          <%= change >= 0 ? '+' : '' %><%= change %>%
        </span>
        <span class="text-[10px] text-text-muted">this month</span>
      </div>
    <% end %>

    <% sparkline_data = @sparkline_data&.dig(account.id) %>
    <% if sparkline_data&.length.to_i >= 2 %>
      <% spark_color = account.balance >= (sparkline_data.first || 0) ? "var(--color-success-500)" : "var(--color-danger-500)" %>
      <div class="mt-2" data-controller="sparkline"
           data-sparkline-data-value="<%= sparkline_data.to_json %>"
           data-sparkline-color-value="<%= spark_color %>"
           data-sparkline-width-value="140"
           data-sparkline-height-value="28">
      </div>
    <% end %>

    <% if account.description.present? %>
      <p class="mt-2 text-xs text-text-muted line-clamp-2"><%= account.description %></p>
    <% end %>

    <% if account.balance_goal.present? && account.balance_goal.positive? %>
      <div class="mt-3">
        <%= render ProgressBarComponent.new(
          value: account.goal_progress,
          label: "Goal: #{number_to_currency(account.balance_goal)}",
          color: :primary,
          warning_threshold: 101,
          danger_threshold: 101
        ) %>
      </div>
    <% end %>

    <% if account.credit_card? && account.credit_limit&.positive? %>
      <div class="mt-3">
        <% util_color = case account.credit_utilization_status
           when :good then :success
           when :warning then :warning
           when :danger then :danger
           end %>
        <%= render ProgressBarComponent.new(
          value: account.credit_utilization,
          label: "#{number_to_currency(account.balance)} / #{number_to_currency(account.credit_limit)} limit",
          color: util_color,
          warning_threshold: 101,
          danger_threshold: 101
        ) %>
        <% if account.interest_rate.present? %>
          <p class="text-[10px] text-text-muted mt-1">APR: <%= account.interest_rate %>%</p>
        <% end %>
      </div>
    <% end %>

    <% if account.loan_account? %>
      <div class="mt-3">
        <% progress = account.loan_progress %>
        <% if progress %>
          <%= render ProgressBarComponent.new(
            value: progress,
            label: "Paid: #{number_to_currency(account.original_loan_amount - account.balance)} / #{number_to_currency(account.original_loan_amount)}",
            color: :success,
            warning_threshold: 101,
            danger_threshold: 101
          ) %>
        <% end %>
        <div class="flex items-center gap-3 mt-1">
          <% if account.interest_rate.present? %>
            <span class="text-[10px] text-text-muted">APR: <%= account.interest_rate %>%</span>
          <% end %>
          <% if (est = account.monthly_payment_estimate) %>
            <span class="text-[10px] text-text-muted">Est. payment: <%= number_to_currency(est) %>/mo</span>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>
</div>
