<!DOCTYPE html>
<html data-controller="theme"
      <% if user_signed_in? %>
        data-theme-theme-mode-value="<%= current_user.preference&.theme_mode || 'system' %>"
        data-theme-color-mode-value="<%= current_user.preference&.color_mode || 'green' %>"
      <% end %>>
  <head>
    <title><%= content_for(:title) || "FinanceApp" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="application-name" content="FinanceApp">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <script>
      (function() {
        var validThemes = ["light", "dark", "system"];
        var validColors = ["green", "blue", "purple", "rose", "amber", "cyan"];
        var theme = localStorage.getItem("theme");
        if (validThemes.indexOf(theme) === -1) theme = "system";
        var isDark = theme === "dark" || (theme === "system" && window.matchMedia("(prefers-color-scheme: dark)").matches);
        if (isDark) document.documentElement.classList.add("dark");
        var color = localStorage.getItem("colorMode");
        if (validColors.indexOf(color) === -1) color = "green";
        if (color !== "green") document.documentElement.classList.add("color-" + color);
        var sidebarExpanded = localStorage.getItem("sidebarExpanded");
        if (window.innerWidth >= 1024 && sidebarExpanded === "false") {
          document.documentElement.classList.add("sidebar-collapsed");
        }
      })();
    </script>

    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="bg-surface-alt min-h-screen text-text-primary" data-controller="toast">
    <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:top-2 focus:left-2 focus:z-[100] focus:px-4 focus:py-2 focus:glass-strong focus:rounded-xl focus:text-primary-600 focus:font-medium">Skip to content</a>

    <% if user_signed_in? %>
      <div data-controller="sidebar">
        <%= render "layouts/sidebar" %>

        <div data-sidebar-target="content" class="sidebar-content min-h-screen flex flex-col">
          <%= render "layouts/topnav" %>

          <main id="main-content" class="flex-1 px-4 sm:px-6 lg:px-8 pt-8 pb-12 max-w-7xl w-full mx-auto relative">
            <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-primary-500/50 to-transparent"></div>

            <% if notice.present? %>
              <div class="hidden" data-toast-target="flash" data-message="<%= notice %>" data-variant="success"></div>
            <% end %>
            <% if alert.present? %>
              <div class="hidden" data-toast-target="flash" data-message="<%= alert %>" data-variant="error"></div>
            <% end %>

            <%= yield %>
          </main>
        </div>
      </div>

    <% else %>
      <%= render "layouts/guest_nav" %>

      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-10 pb-12">
        <% if notice.present? %>
          <div class="hidden" data-toast-target="flash" data-message="<%= notice %>" data-variant="success"></div>
        <% end %>
        <% if alert.present? %>
          <div class="hidden" data-toast-target="flash" data-message="<%= alert %>" data-variant="error"></div>
        <% end %>

        <%= yield %>
      </div>
    <% end %>

    <div id="toast-container" class="fixed top-4 right-4 z-[60] flex flex-col gap-3 pointer-events-none"></div>
  </body>
</html>
