<div class="space-y-6">
  <%= render PageHeaderComponent.new(title: "Period Comparisons", subtitle: "Compare spending between two time periods") do |header| %>
    <% header.with_actions do %>
      <%= render ButtonComponent.new(variant: :secondary, href: reports_path, icon: "arrow-left") do %>
        All Reports
      <% end %>
    <% end %>
  <% end %>

  <%# Period Selection %>
  <%= render CardComponent.new do %>
    <%= form_with url: comparisons_reports_path, method: :get, class: "space-y-4" do |f| %>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <%# Period 1 %>
        <div class="p-4 rounded-xl border border-blue-500/30 bg-blue-500/5">
          <h3 class="text-sm font-semibold text-blue-600 dark:text-blue-400 mb-3 flex items-center gap-2">
            <%= heroicon "calendar", variant: :outline, options: { class: "w-4 h-4" } %>
            Period 1 (Current)
          </h3>
          <div class="flex gap-3">
            <div class="flex-1">
              <label class="block text-xs font-medium text-text-secondary mb-1">Start</label>
              <input type="date" name="period1_start" value="<%= @period1_start %>"
                     class="w-full glass rounded-xl px-3 py-2 text-sm text-text-primary border border-glass-border focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-transparent">
            </div>
            <div class="flex-1">
              <label class="block text-xs font-medium text-text-secondary mb-1">End</label>
              <input type="date" name="period1_end" value="<%= @period1_end %>"
                     class="w-full glass rounded-xl px-3 py-2 text-sm text-text-primary border border-glass-border focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-transparent">
            </div>
          </div>
        </div>

        <%# Period 2 %>
        <div class="p-4 rounded-xl border border-purple-500/30 bg-purple-500/5">
          <h3 class="text-sm font-semibold text-purple-600 dark:text-purple-400 mb-3 flex items-center gap-2">
            <%= heroicon "calendar", variant: :outline, options: { class: "w-4 h-4" } %>
            Period 2 (Previous)
          </h3>
          <div class="flex gap-3">
            <div class="flex-1">
              <label class="block text-xs font-medium text-text-secondary mb-1">Start</label>
              <input type="date" name="period2_start" value="<%= @period2_start %>"
                     class="w-full glass rounded-xl px-3 py-2 text-sm text-text-primary border border-glass-border focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-transparent">
            </div>
            <div class="flex-1">
              <label class="block text-xs font-medium text-text-secondary mb-1">End</label>
              <input type="date" name="period2_end" value="<%= @period2_end %>"
                     class="w-full glass rounded-xl px-3 py-2 text-sm text-text-primary border border-glass-border focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-transparent">
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-end">
        <%= render ButtonComponent.new(variant: :primary, submit: true, icon: "arrows-right-left") do %>
          Compare Periods
        <% end %>
      </div>
    <% end %>
  <% end %>

  <%# Summary Cards %>
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 animate-card-entrance stagger-1">
    <div data-controller="counter">
      <%= render StatCardComponent.new(
        label: @period1_label,
        value: number_to_currency(@period1_total),
        icon: "calendar",
        color: "text-blue-600"
      ) %>
    </div>
    <div data-controller="counter">
      <%= render StatCardComponent.new(
        label: @period2_label,
        value: number_to_currency(@period2_total),
        icon: "calendar",
        color: "text-purple-600"
      ) %>
    </div>
    <div data-controller="counter">
      <%= render StatCardComponent.new(
        label: "Change",
        value: "#{@total_change >= 0 ? '+' : ''}#{@total_change}%",
        icon: @total_change >= 0 ? "arrow-trending-up" : "arrow-trending-down",
        color: @total_change <= 0 ? "text-success-600" : "text-danger-600"
      ) %>
    </div>
  </div>

  <% if @comparison_data.any? %>
    <%# Side-by-side Bar Chart %>
    <div class="animate-card-entrance stagger-2">
      <%= render CardComponent.new do |card| %>
        <% card.with_header do %>
          <h2 class="text-xl font-semibold text-text-primary">Category Comparison</h2>
        <% end %>
        <div class="h-80">
          <canvas data-controller="chart"
                  data-chart-type-value="bar"
                  data-chart-data-value="<%= @chart_data.to_json %>"></canvas>
        </div>
      <% end %>
    </div>

    <%# Comparison Table %>
    <div class="animate-card-entrance stagger-3">
      <%= render CardComponent.new(padding: false) do |card| %>
        <% card.with_header do %>
          <h2 class="text-xl font-semibold text-text-primary">Detailed Comparison</h2>
        <% end %>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-glass-border">
                <th class="text-left px-6 py-3 text-xs font-semibold text-text-muted uppercase tracking-wider">Category</th>
                <th class="text-right px-6 py-3 text-xs font-semibold text-blue-600 uppercase tracking-wider"><%= @period1_label %></th>
                <th class="text-right px-6 py-3 text-xs font-semibold text-purple-600 uppercase tracking-wider"><%= @period2_label %></th>
                <th class="text-right px-6 py-3 text-xs font-semibold text-text-muted uppercase tracking-wider">Change</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-glass-border">
              <% @comparison_data.each do |row| %>
                <tr class="hover:bg-surface-hover/30 transition-colors">
                  <td class="px-6 py-4 text-sm font-medium text-text-primary"><%= row[:category] %></td>
                  <td class="px-6 py-4 text-sm font-semibold text-text-primary text-right"><%= number_to_currency(row[:period1]) %></td>
                  <td class="px-6 py-4 text-sm font-semibold text-text-primary text-right"><%= number_to_currency(row[:period2]) %></td>
                  <td class="px-6 py-4 text-sm font-semibold text-right">
                    <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium
                      <%= row[:change] <= 0 ? 'bg-success-50 text-success-700' : 'bg-danger-50 text-danger-700' %>">
                      <% if row[:change] != 0 %>
                        <%= heroicon(row[:change] > 0 ? "arrow-up" : "arrow-down", variant: :mini, options: { class: "w-3 h-3" }) %>
                      <% end %>
                      <%= row[:change] >= 0 ? "+" : "" %><%= row[:change] %>%
                    </span>
                  </td>
                </tr>
              <% end %>
            </tbody>
            <tfoot>
              <tr class="border-t-2 border-glass-border bg-surface-hover/20">
                <td class="px-6 py-4 text-sm font-bold text-text-primary">Total</td>
                <td class="px-6 py-4 text-sm font-bold text-text-primary text-right"><%= number_to_currency(@period1_total) %></td>
                <td class="px-6 py-4 text-sm font-bold text-text-primary text-right"><%= number_to_currency(@period2_total) %></td>
                <td class="px-6 py-4 text-sm font-bold text-right">
                  <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium
                    <%= @total_change <= 0 ? 'bg-success-50 text-success-700' : 'bg-danger-50 text-danger-700' %>">
                    <% if @total_change != 0 %>
                      <%= heroicon(@total_change > 0 ? "arrow-up" : "arrow-down", variant: :mini, options: { class: "w-3 h-3" }) %>
                    <% end %>
                    <%= @total_change >= 0 ? "+" : "" %><%= @total_change %>%
                  </span>
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      <% end %>
    </div>
  <% else %>
    <%= render CardComponent.new do %>
      <%= render EmptyStateComponent.new(
        title: "No comparison data",
        description: "No expense transactions found for the selected periods.",
        icon: "arrows-right-left"
      ) %>
    <% end %>
  <% end %>
</div>
