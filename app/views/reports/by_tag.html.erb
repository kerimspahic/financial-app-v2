<div class="space-y-6">
  <%= render PageHeaderComponent.new(title: "Spending by Tag", subtitle: "Expense breakdown by tag") do |header| %>
    <% header.with_actions do %>
      <%= render ButtonComponent.new(variant: :secondary, href: reports_path, icon: "arrow-left") do %>
        All Reports
      <% end %>
    <% end %>
  <% end %>

  <%# Date Range Filter %>
  <%= render CardComponent.new do %>
    <%= form_with url: by_tag_reports_path, method: :get, class: "flex flex-wrap items-end gap-4" do |f| %>
      <div class="flex-1 min-w-[180px]">
        <label class="block text-sm font-medium text-text-secondary mb-1">Start Date</label>
        <input type="date" name="start_date" value="<%= @start_date %>"
               class="w-full glass rounded-xl px-4 py-2 text-text-primary border border-glass-border focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-transparent">
      </div>
      <div class="flex-1 min-w-[180px]">
        <label class="block text-sm font-medium text-text-secondary mb-1">End Date</label>
        <input type="date" name="end_date" value="<%= @end_date %>"
               class="w-full glass rounded-xl px-4 py-2 text-text-primary border border-glass-border focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-transparent">
      </div>
      <div>
        <%= render ButtonComponent.new(variant: :primary, submit: true, icon: "funnel") do %>
          Apply Filter
        <% end %>
      </div>
    <% end %>
  <% end %>

  <% if @tag_data.any? %>
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <%# Doughnut Chart %>
      <div class="animate-card-entrance stagger-1">
        <%= render CardComponent.new do |card| %>
          <% card.with_header do %>
            <div class="flex justify-between items-center">
              <h2 class="text-xl font-semibold text-text-primary">Tag Distribution</h2>
              <p class="text-sm text-text-secondary">Total: <%= number_to_currency(@total_spent) %></p>
            </div>
          <% end %>
          <div class="h-80">
            <canvas data-controller="chart"
                    data-chart-type-value="doughnut"
                    data-chart-data-value="<%= @chart_data.to_json %>"></canvas>
          </div>
        <% end %>
      </div>

      <%# Summary Cards %>
      <div class="animate-card-entrance stagger-2">
        <%= render CardComponent.new do |card| %>
          <% card.with_header do %>
            <h2 class="text-xl font-semibold text-text-primary">Tag Summary</h2>
          <% end %>
          <div class="space-y-3">
            <% @tag_data.each do |tag| %>
              <div class="flex items-center gap-3 p-3 rounded-xl hover:bg-surface-hover/30 transition-colors">
                <div class="w-4 h-4 rounded-full flex-shrink-0" style="background-color: <%= tag.color.presence || '#6b7280' %>"></div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-text-primary"><%= tag.name %></p>
                  <p class="text-xs text-text-secondary"><%= tag.tx_count %> transactions</p>
                </div>
                <div class="text-right">
                  <p class="text-sm font-semibold text-danger-600"><%= number_to_currency(tag.total_spent) %></p>
                  <% pct = @total_spent > 0 ? (tag.total_spent / @total_spent * 100).round(1) : 0 %>
                  <p class="text-xs text-text-secondary"><%= pct %>%</p>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <%# Detailed Table %>
    <div class="animate-card-entrance stagger-3">
      <%= render CardComponent.new(padding: false) do |card| %>
        <% card.with_header do %>
          <h2 class="text-xl font-semibold text-text-primary">Detailed Breakdown</h2>
        <% end %>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-glass-border">
                <th class="text-left px-6 py-3 text-xs font-semibold text-text-muted uppercase tracking-wider">Tag</th>
                <th class="text-right px-6 py-3 text-xs font-semibold text-text-muted uppercase tracking-wider">Transactions</th>
                <th class="text-right px-6 py-3 text-xs font-semibold text-text-muted uppercase tracking-wider">Total Spent</th>
                <th class="text-right px-6 py-3 text-xs font-semibold text-text-muted uppercase tracking-wider">% of Total</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-glass-border">
              <% @tag_data.each do |tag| %>
                <tr class="hover:bg-surface-hover/30 transition-colors">
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-2">
                      <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: <%= tag.color.presence || '#6b7280' %>"></div>
                      <span class="text-sm font-medium text-text-primary"><%= tag.name %></span>
                    </div>
                  </td>
                  <td class="px-6 py-4 text-sm text-text-secondary text-right"><%= tag.tx_count %></td>
                  <td class="px-6 py-4 text-sm font-semibold text-danger-600 text-right"><%= number_to_currency(tag.total_spent) %></td>
                  <td class="px-6 py-4 text-sm text-text-secondary text-right">
                    <% pct = @total_spent > 0 ? (tag.total_spent / @total_spent * 100).round(1) : 0 %>
                    <%= pct %>%
                  </td>
                </tr>
              <% end %>
            </tbody>
            <tfoot>
              <tr class="border-t-2 border-glass-border bg-surface-hover/20">
                <td class="px-6 py-4 text-sm font-bold text-text-primary">Total</td>
                <td class="px-6 py-4 text-sm font-bold text-text-primary text-right"><%= @tag_data.sum(&:tx_count) %></td>
                <td class="px-6 py-4 text-sm font-bold text-danger-600 text-right"><%= number_to_currency(@total_spent) %></td>
                <td class="px-6 py-4 text-sm font-bold text-text-primary text-right">100%</td>
              </tr>
            </tfoot>
          </table>
        </div>
      <% end %>
    </div>
  <% else %>
    <%= render CardComponent.new do %>
      <%= render EmptyStateComponent.new(
        title: "No tag data",
        description: "No expense transactions with tags found for this date range. Try adding tags to your transactions.",
        icon: "tag"
      ) %>
    <% end %>
  <% end %>
</div>
